#include <stdint.h>  // Типы фиксированной ширины
#include <string.h>  // Функции работы с памятью (memset)

#include "../s21_decimal.h"

//Функция сложения десималь чисел

//Бановское округление после деления на 10 для 96 бит
/*
Если остаток > 5 или равен 5 и число нечет 
То округляем вверх*/

static void bankers_round_after_div10_96(uint32_t a[3], uint32_t rem){

    if(rem > 5 || (rem == 5u && (a[0] & 1u))){
        // Число 1 в формате 96 бит
        uint32_t one[3] = {1, 0, 0};
        // Прибавляем 1 и игнорируем переполнение
        (void)u96_add(a,one);
    }
}

//Удаление незначащих нулей в конце числа
/*
Уменьшает масштаб, деля число на 10, пока это возможно*/

static void strip_trailing_zeros(uint32_t a[3], int* scale){

    uint32_t tmp[3] = {0, 0, 0};
    u96_copy(tmp, a);

    while(*scale > 0 && u96_div10(tmp) == 0){
        //сохраняем результат деления
        u96_copy(a, tmp);
        //уменьшаем масштаб
        (*scale)--;
        // готовим к следующей итерации
        u96_copy(tmp,a);
    }
}

// Деление 128 бит числа на 10
/*
Выполняет деление "в столбик" от старших разрядов к младшим*/
static uint32_t u128_div10(uint32_t a[4]){

    uint64_t rem = 0;

    // от старшего разряда к младшему
    for(int i = 3; i >= 0; i--) {
        // текущий число - остаток + новый разряд
        uint64_t curr = (rem << 32) | a[i];
        // частное записываем обратно
        a[i] = (uint32_t)(curr / 10);
        // остаток для следующей итерации
        rem = curr % 10;
    }

    return (uint32_t)rem;
}